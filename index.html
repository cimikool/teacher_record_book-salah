<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4A90E2">
    <title>Teacher Record Book - Prof. Salah Sahmoudi</title>
    <link rel="manifest" href="manifest.json">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            background: white;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .header p {
            font-size: 12px;
            color: #666;
        }
        
        .container {
            padding: 15px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .date-header {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .date-header h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .date-header p {
            font-size: 14px;
            color: #666;
        }
        
        .class-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .class-card:active {
            transform: scale(0.98);
        }
        
        .class-card.logged {
            background: #f0f9ff;
            border-left: 4px solid #4A90E2;
        }
        
        .class-time {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .class-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }
        
        .class-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-logged {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .student-count {
            display: inline-block;
            margin-left: 8px;
            font-size: 12px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .modal.active {
            display: flex;
            align-items: flex-start;
            padding: 20px 0;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            margin: auto;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            position: sticky;
            top: 0;
            background: white;
            border-radius: 15px 15px 0 0;
        }
        
        .modal-header h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 5px;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4A90E2;
        }
        
        .form-textarea {
            min-height: 60px;
            resize: vertical;
            font-family: inherit;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            position: sticky;
            bottom: 0;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #4A90E2;
            color: white;
        }
        
        .btn-primary:active {
            background: #357ABD;
        }
        
        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }
        
        .btn-secondary:active {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 99;
        }
        
        .bottom-nav-item {
            flex: 1;
            text-align: center;
            padding: 5px;
            color: #666;
            font-size: 11px;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .bottom-nav-item.active {
            color: #4A90E2;
        }
        
        .bottom-nav-item svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 15px;
        }
        
        .student-list-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-list-item:last-child {
            border-bottom: none;
        }
        
        .student-name {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }
        
        .student-info {
            font-size: 12px;
            color: #666;
            margin-top: 3px;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 6px;
            border: none;
            background: #4A90E2;
            color: white;
            cursor: pointer;
        }
        
        .file-upload {
            display: none;
        }
        
        .upload-area {
            border: 2px dashed #4A90E2;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .upload-area:hover {
            background: #f0f9ff;
        }
        
        .upload-area svg {
            width: 48px;
            height: 48px;
            color: #4A90E2;
            margin-bottom: 10px;
        }
        
        .diagnostic-note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .diagnostic-note h4 {
            color: #856404;
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .diagnostic-note p {
            color: #856404;
            font-size: 13px;
            line-height: 1.5;
        }
        
        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4A90E2;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .attendance-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .attendance-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .attendance-checkbox {
            width: 20px;
            height: 20px;
            margin-right: 10px;
        }
        
        .grade-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            text-align: center;
            font-size: 14px;
        }
        
        .holiday-item {
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #4A90E2;
        }
        
        .holiday-date {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        
        .holiday-name {
            color: #666;
            font-size: 14px;
        }
        
        .holiday-type {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            margin-top: 5px;
        }
        
        .holiday-type.fixed {
            background: #28a745;
            color: white;
        }
        
        .holiday-type.approximate {
            background: #ffc107;
            color: #000;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìö Teacher Record Book</h1>
        <p>Prof. Salah Sahmoudi - Abdellah Guennoun High School</p>
    </div>
    
    <div class="container">
        <!-- Today Tab -->
        <div id="todayTab" class="tab-content active">
            <div class="date-header">
                <h2 id="currentDate"></h2>
                <p id="todayStatus">Today's Classes</p>
            </div>
            <div id="todayClasses"></div>
        </div>
        
        <!-- Records Tab -->
        <div id="recordsTab" class="tab-content">
            <div class="date-header">
                <h2>All Records</h2>
                <p>View and manage your lessons</p>
            </div>
            <select class="form-select" id="classFilter" style="margin-bottom: 15px;">
                <option value="">All Classes</option>
                <option value="CCS1">CCS1</option>
                <option value="CCS2">CCS2</option>
                <option value="CCSF1">CCSF1</option>
                <option value="CCSF2">CCSF2</option>
                <option value="CCSF3">CCSF3</option>
                <option value="2BAC SP1">2BAC SP1</option>
                <option value="2BAC SP2">2BAC SP2</option>
            </select>
            <div id="recordsList"></div>
        </div>
        
        <!-- Students Tab -->
        <div id="studentsTab" class="tab-content">
            <div class="date-header">
                <h2>üë• Students Management</h2>
                <p>Manage students, grades, and attendance</p>
            </div>
            
            <div class="card">
                <label class="form-label">Select Class:</label>
                <select class="form-select" id="studentClassFilter">
                    <option value="CCS1">CCS1</option>
                    <option value="CCS2">CCS2</option>
                    <option value="CCSF1">CCSF1</option>
                    <option value="CCSF2">CCSF2</option>
                    <option value="CCSF3">CCSF3</option>
                    <option value="2BAC SP1">2BAC SP1</option>
                    <option value="2BAC SP2">2BAC SP2</option>
                </select>
                
                <div style="margin-top: 20px;">
                    <input type="file" id="excelUpload" class="file-upload" accept=".xlsx,.xls">
                    <div class="upload-area" onclick="document.getElementById('excelUpload').click()">
                        <svg fill="currentColor" viewBox="0 0 20 20"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.977A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.413V13H5.5z"/><path d="M9 13h2v5a1 1 0 11-2 0v-5z"/></svg>
                        <p style="color: #4A90E2; font-weight: 600;">Upload Excel File</p>
                        <p style="font-size: 12px; color: #666; margin-top: 5px;">Click to select student list (.xlsx or .xls)</p>
                    </div>
                </div>
            </div>
            
            <!-- Diagnostic Note -->
            <div class="diagnostic-note" id="diagnosticNote">
                <h4>‚ö†Ô∏è Diagnostic Test Note</h4>
                <p>Diagnostic tests were scheduled at the beginning of the academic year. However, due to significant student absences on the scheduled test days, comprehensive assessment was not possible. The first three lessons were dedicated to reviewing main tenses (Simple Present, Present Continuous, Simple Past) to ensure all students have foundational knowledge before starting Unit 1.</p>
            </div>
            
            <div class="card">
                <h3>Students (<span id="studentCount">0</span>)</h3>
                <div id="studentsList"></div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-primary" onclick="openGradeEntry()">üìä Enter Grades</button>
                <button class="btn btn-secondary" onclick="openAttendanceSheet()">‚úì Attendance</button>
            </div>
        </div>
        
        <!-- Holidays Tab -->
        <div id="holidaysTab" class="tab-content">
            <div class="date-header">
                <h2>üìÖ Academic Calendar 2025-2026</h2>
                <p>Moroccan National & Religious Holidays</p>
            </div>
            
            <div class="card">
                <h3>üá≤üá¶ National Holidays (Fixed)</h3>
                <div id="nationalHolidays"></div>
            </div>
            
            <div class="card">
                <h3>üåô Religious Holidays (Approximate)</h3>
                <p style="font-size: 12px; color: #666; margin-bottom: 15px;">‚ö†Ô∏è Dates subject to official moon sighting announcements</p>
                <div id="religiousHolidays"></div>
            </div>
            
            <div class="card">
                <h3>üìù Personal Days</h3>
                <button class="btn btn-primary" onclick="addPersonalDay()">+ Add Leave/Sick Day</button>
                <div id="personalDays" style="margin-top: 15px;"></div>
            </div>
        </div>
        
        <!-- Export Tab -->
        <div id="exportTab" class="tab-content">
            <div class="date-header">
                <h2>üì• Export Records</h2>
                <p>Generate comprehensive reports</p>
            </div>
            
            <div class="card">
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="exportFullRecord()">üìÑ Export Complete Record Book</button>
                <button class="btn btn-secondary" style="width: 100%; margin-bottom: 10px;" onclick="exportClassReport()">üìä Export Class Report</button>
                <button class="btn btn-secondary" style="width: 100%;" onclick="exportGradeSheet()">üìà Export Grade Sheet</button>
            </div>
        </div>
    </div>
    
    <!-- Lesson Entry Modal -->
    <div id="lessonModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Log Lesson</h3>
                <p id="modalSubtitle"></p>
            </div>
            <div class="modal-body">
                <form id="lessonForm">
                    <input type="hidden" id="lessonId">
                    <input type="hidden" id="lessonClass">
                    
                    <div class="form-group">
                        <label class="form-label">Date</label>
                        <input type="date" class="form-input" id="lessonDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="lessonType" required>
                            <option value="">Select Type</option>
                            <option value="Grammar">Grammar</option>
                            <option value="Reading">Reading</option>
                            <option value="Writing">Writing</option>
                            <option value="Vocabulary">Vocabulary</option>
                            <option value="Communication">Communication</option>
                            <option value="Speaking">Speaking</option>
                            <option value="Practice">Practice</option>
                            <option value="Review">Review</option>
                            <option value="Assessment">Assessment</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Lesson Title</label>
                        <input type="text" class="form-input" id="lessonTitle" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Materials Used</label>
                        <select class="form-select" id="lessonMaterials">
                            <option value="Interactive lessons using data show">Interactive lessons using data show</option>
                            <option value="Textbook exercises">Textbook exercises</option>
                            <option value="Whiteboard activities">Whiteboard activities</option>
                            <option value="Worksheets and handouts">Worksheets and handouts</option>
                            <option value="Audio/Video materials">Audio/Video materials</option>
                            <option value="Group work activities">Group work activities</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Main Point 1</label>
                        <textarea class="form-textarea" id="point1" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Main Point 2</label>
                        <textarea class="form-textarea" id="point2" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Main Point 3</label>
                        <textarea class="form-textarea" id="point3" required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Homework (Optional)</label>
                        <textarea class="form-textarea" id="homework" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('lessonModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveLesson()">Save & Mark Attendance</button>
            </div>
        </div>
    </div>
    
    <!-- Attendance Modal -->
    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úì Mark Attendance</h3>
                <p id="attendanceSubtitle"></p>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <button class="btn btn-success" onclick="markAllPresent()">‚úì All Present</button>
                    <button class="btn btn-secondary" onclick="markAllAbsent()">‚úó All Absent</button>
                </div>
                <div class="attendance-grid" id="attendanceList"></div>
                <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                    <span>Present: <strong id="presentCount">0</strong></span>
                    <span style="margin-left: 20px;">Absent: <strong id="absentCount">0</strong></span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('attendanceModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAttendance()">Save Attendance</button>
            </div>
        </div>
    </div>
    
    <!-- Student Profile Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Student Profile</h3>
                <p id="studentName"></p>
            </div>
            <div class="modal-body" id="studentProfile"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('studentModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Grade Entry Modal -->
    <div id="gradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìä Enter Grades</h3>
                <p id="gradeSubtitle"></p>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Select Assessment:</label>
                    <select class="form-select" id="gradeType" onchange="updateGradeForm()">
                        <option value="test1">Test 1 (out of 15)</option>
                        <option value="test2">Test 2 (out of 15)</option>
                        <option value="globalTest">Global Test (out of 30)</option>
                        <option value="copyBook">Copy Book (out of 24)</option>
                        <option value="discipline">Discipline (out of 8)</option>
                        <option value="oralTest">Oral Test (out of 8)</option>
                    </select>
                </div>
                <div id="gradesList" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('gradeModal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveGrades()">Save Grades</button>
            </div>
        </div>
    </div>
    
    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="bottom-nav-item active" onclick="switchTab('today')">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg>
            <div>Today</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('records')">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg>
            <div>Records</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('students')">
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/></svg>
            <div>Students</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('holidays')">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/></svg>
            <div>Calendar</div>
        </div>
        <div class="bottom-nav-item" onclick="switchTab('export')">
            <svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
            <div>Export</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Moroccan Holidays 2025-2026
        const moroccanHolidays = {
            national: [
                {date: '2026-01-01', name: 'New Year\'s Day (Nouvel An)', type: 'fixed'},
                {date: '2026-01-11', name: 'Independence Manifesto Day', type: 'fixed'},
                {date: '2026-05-01', name: 'Labour Day (F√™te du Travail)', type: 'fixed'},
                {date: '2026-07-30', name: 'Throne Day (F√™te du Tr√¥ne)', type: 'fixed'},
                {date: '2026-08-14', name: 'Oued Ed-Dahab Day', type: 'fixed'},
                {date: '2026-08-20', name: 'Revolution Day', type: 'fixed'},
                {date: '2026-08-21', name: 'Youth Day (F√™te de la Jeunesse)', type: 'fixed'},
                {date: '2026-11-06', name: 'Green March Day (Marche Verte)', type: 'fixed'},
                {date: '2026-11-18', name: 'Independence Day', type: 'fixed'}
            ],
            religious: [
                {date: '2025-09-05', name: 'Mawlid al-Nabi (ÿπŸäÿØ ÿßŸÑŸÖŸàŸÑÿØ ÿßŸÑŸÜÿ®ŸàŸä)', type: 'approximate', editable: true},
                {date: '2026-03-20', name: 'Eid al-Fitr Day 1 (ÿπŸäÿØ ÿßŸÑŸÅÿ∑ÿ±)', type: 'approximate', editable: true},
                {date: '2026-03-21', name: 'Eid al-Fitr Day 2 (ÿπŸäÿØ ÿßŸÑŸÅÿ∑ÿ±)', type: 'approximate', editable: true},
                {date: '2026-05-27', name: 'Eid al-Adha Day 1 (ÿπŸäÿØ ÿßŸÑÿ£ÿ∂ÿ≠Ÿâ)', type: 'approximate', editable: true},
                {date: '2026-05-28', name: 'Eid al-Adha Day 2 (ÿπŸäÿØ ÿßŸÑÿ£ÿ∂ÿ≠Ÿâ)', type: 'approximate', editable: true},
                {date: '2026-06-16', name: 'Islamic New Year (ÿ±ÿ£ÿ≥ ÿßŸÑÿ≥ŸÜÿ© ÿßŸÑŸáÿ¨ÿ±Ÿäÿ©)', type: 'approximate', editable: true},
                {date: '2026-08-25', name: 'Mawlid al-Nabi (ÿπŸäÿØ ÿßŸÑŸÖŸàŸÑÿØ ÿßŸÑŸÜÿ®ŸàŸä)', type: 'approximate', editable: true}
            ]
        };
        
        // Timetable
        const defaultTimetable = {
            'Monday': [
                {time: '8:30-9:30', class: 'CCS1'},
                {time: '9:30-10:30', class: 'CCS2'},
                {time: '10:30-11:30', class: 'CCSF3'},
                {time: '11:30-12:30', class: 'CCSF2'}
            ],
            'Tuesday': [
                {time: '10:30-11:30', class: 'CCSF1'},
                {time: '11:30-12:30', class: 'CCSF2'}
            ],
            'Wednesday': [
                {time: '14:30-15:30', class: '2BAC SP1'},
                {time: '15:30-16:30', class: 'CCSF3'},
                {time: '16:30-17:30', class: 'CCS1'},
                {time: '17:30-18:30', class: 'CCSF1'}
            ],
            'Thursday': [
                {time: '14:30-15:30', class: 'CCSF2'},
                {time: '15:30-16:30', class: '2BAC SP2'},
                {time: '16:30-17:30', class: '2BAC SP1'},
                {time: '17:30-18:30', class: 'CCS2'}
            ],
            'Friday': [
                {time: '8:30-9:30', class: 'CCS2'},
                {time: '9:30-10:30', class: '2BAC SP2'},
                {time: '10:30-11:30', class: '2BAC SP1'},
                {time: '11:30-12:30', class: 'CCS1'}
            ],
            'Saturday': [
                {time: '9:30-10:30', class: 'CCSF1'},
                {time: '10:30-11:30', class: '2BAC SP2'},
                {time: '11:30-12:30', class: 'CCSF3'}
            ]
        };
        
        let currentEditingLesson = null;
        let currentAttendanceData = null;
        
        // Get timetable
        function getTimetable() {
            const stored = localStorage.getItem('weeklyTimetable');
            if (stored) return JSON.parse(stored);
            localStorage.setItem('weeklyTimetable', JSON.stringify(defaultTimetable));
            return defaultTimetable;
        }
        
        // Display current date
        function displayCurrentDate() {
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const date = new Date().toLocaleDateString('en-US', options);
            document.getElementById('currentDate').textContent = date;
            
            // Check if today is a holiday
            const todayStr = new Date().toISOString().split('T')[0];
            const allHolidays = [...moroccanHolidays.national, ...moroccanHolidays.religious];
            const todayHoliday = allHolidays.find(h => h.date === todayStr);
            
            if (todayHoliday) {
                document.getElementById('todayStatus').innerHTML = `üéâ Public Holiday: ${todayHoliday.name}`;
            }
        }
        
        // Get day name
        function getDayName(date = new Date()) {
            return date.toLocaleDateString('en-US', { weekday: 'long' });
        }
        
        // Get/Set data functions
        function getLessons() {
            return JSON.parse(localStorage.getItem('teacherLessons') || '[]');
        }
        
        function getStudents(className) {
            const allStudents = JSON.parse(localStorage.getItem('students') || '{}');
            return allStudents[className] || [];
        }
        
        function saveStudents(className, students) {
            const allStudents = JSON.parse(localStorage.getItem('students') || '{}');
            allStudents[className] = students;
            localStorage.setItem('students', JSON.stringify(allStudents));
        }
        
        function getAttendance() {
            return JSON.parse(localStorage.getItem('attendance') || '{}');
        }
        
        function saveAttendance(data) {
            localStorage.setItem('attendance', JSON.stringify(data));
        }
        
        // Display today's classes
        function displayTodayClasses() {
            const today = getDayName();
            const timetable = getTimetable();
            const classes = timetable[today] || [];
            const container = document.getElementById('todayClasses');
            
            if (classes.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No classes scheduled for today</p></div>';
                return;
            }
            
            const lessons = getLessons();
            const todayDate = new Date().toISOString().split('T')[0];
            
            container.innerHTML = classes.map(classInfo => {
                const logged = lessons.find(l => 
                    l.class === classInfo.class && 
                    l.date === todayDate
                );
                
                const students = getStudents(classInfo.class);
                const studentCount = students.length;
                
                return `
                    <div class="class-card ${logged ? 'logged' : ''}" onclick="openLessonModal('${classInfo.class}', '${classInfo.time}')">
                        <div class="class-time">${classInfo.time}</div>
                        <div class="class-name">
                            ${classInfo.class}
                            ${studentCount > 0 ? `<span class="student-count">üë• ${studentCount}</span>` : ''}
                        </div>
                        <span class="class-status ${logged ? 'status-logged' : 'status-pending'}">
                            ${logged ? '‚úì Logged' : 'Tap to Log'}
                        </span>
                        ${logged ? `
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; font-size: 13px;">
                                <strong>${logged.title}</strong><br>
                                <span style="color: #666;">${logged.materials}</span>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Open lesson modal
        function openLessonModal(className, time = '') {
            currentEditingLesson = null;
            document.getElementById('modalTitle').textContent = `Log Lesson: ${className}`;
            document.getElementById('modalSubtitle').textContent = time;
            document.getElementById('lessonClass').value = className;
            document.getElementById('lessonDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('lessonForm').reset();
            document.getElementById('lessonClass').value = className;
            document.getElementById('lessonDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('lessonMaterials').value = 'Interactive lessons using data show';
            document.getElementById('lessonModal').classList.add('active');
        }
        
        // Close modal
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // Save lesson
        function saveLesson() {
            const form = document.getElementById('lessonForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const lesson = {
                id: currentEditingLesson?.id || Date.now().toString(),
                class: document.getElementById('lessonClass').value,
                date: document.getElementById('lessonDate').value,
                type: document.getElementById('lessonType').value,
                title: document.getElementById('lessonTitle').value,
                materials: document.getElementById('lessonMaterials').value,
                points: [
                    document.getElementById('point1').value,
                    document.getElementById('point2').value,
                    document.getElementById('point3').value
                ],
                homework: document.getElementById('homework').value,
                timestamp: new Date().toISOString()
            };
            
            let lessons = getLessons();
            
            if (currentEditingLesson) {
                lessons = lessons.map(l => l.id === lesson.id ? lesson : l);
            } else {
                lessons.push(lesson);
            }
            
            localStorage.setItem('teacherLessons', JSON.stringify(lessons));
            closeModal('lessonModal');
            
            // Open attendance modal
            currentAttendanceData = lesson;
            openAttendanceModal();
            
            displayTodayClasses();
            displayAllRecords();
        }
        
        // Open attendance modal
        function openAttendanceModal() {
            const lesson = currentAttendanceData;
            document.getElementById('attendanceSubtitle').textContent = 
                `${lesson.class} - ${lesson.date} - ${lesson.title}`;
            
            const students = getStudents(lesson.class);
            if (students.length === 0) {
                alert('No students in this class. Please upload student list first.');
                return;
            }
            
            const attendanceList = document.getElementById('attendanceList');
            attendanceList.innerHTML = students.map((student, index) => {
                const absences = student.attendance?.filter(a => !a.present).length || 0;
                return `
                    <div class="attendance-item">
                        <input type="checkbox" class="attendance-checkbox" id="student-${index}" checked>
                        <div style="flex: 1;">
                            <div class="student-name">${student.name}</div>
                            <div class="student-info">Previous absences: ${absences}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateAttendanceCount();
            document.getElementById('attendanceModal').classList.add('active');
        }
        
        function openAttendanceSheet() {
            const className = document.getElementById('studentClassFilter').value;
            const students = getStudents(className);
            
            if (students.length === 0) {
                alert('No students in this class. Please upload student list first.');
                return;
            }
            
            currentAttendanceData = {
                class: className,
                date: new Date().toISOString().split('T')[0],
                title: 'Manual Attendance Entry'
            };
            
            openAttendanceModal();
        }
        
        // Attendance functions
        function markAllPresent() {
            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateAttendanceCount();
        }
        
        function markAllAbsent() {
            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateAttendanceCount();
        }
        
        function updateAttendanceCount() {
            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            const present = Array.from(checkboxes).filter(cb => cb.checked).length;
            const absent = checkboxes.length - present;
            document.getElementById('presentCount').textContent = present;
            document.getElementById('absentCount').textContent = absent;
        }
        
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('attendance-checkbox')) {
                updateAttendanceCount();
            }
        });
        
        function saveAttendance() {
            const lesson = currentAttendanceData;
            const className = lesson.class;
            const students = getStudents(className);
            const checkboxes = document.querySelectorAll('.attendance-checkbox');
            
            students.forEach((student, index) => {
                if (!student.attendance) student.attendance = [];
                
                const isPresent = checkboxes[index].checked;
                student.attendance.push({
                    date: lesson.date,
                    present: isPresent,
                    lesson: lesson.title
                });
            });
            
            saveStudents(className, students);
            closeModal('attendanceModal');
            alert('‚úì Attendance saved!');
            displayStudentsList();
        }
        
        // Excel upload
        document.getElementById('excelUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                    
                    const studentNames = jsonData
                        .filter(row => row[0] && typeof row[0] === 'string')
                        .map(row => ({
                            name: row[0].trim(),
                            grades: {
                                test1: null,
                                test2: null,
                                globalTest: null,
                                copyBook: null,
                                discipline: null,
                                oralTest: null
                            },
                            attendance: [],
                            hasCopyBook: false
                        }));
                    
                    if (studentNames.length === 0) {
                        alert('No valid student names found in the file.');
                        return;
                    }
                    
                    const className = document.getElementById('studentClassFilter').value;
                    saveStudents(className, studentNames);
                    
                    alert(`‚úì Successfully imported ${studentNames.length} students!`);
                    displayStudentsList();
                } catch (error) {
                    alert('Error reading file. Please ensure it\'s a valid Excel file (.xlsx or .xls)');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        });
        
        // Display students list
        function displayStudentsList() {
            const className = document.getElementById('studentClassFilter').value;
            const students = getStudents(className);
            document.getElementById('studentCount').textContent = students.length;
            
            const container = document.getElementById('studentsList');
            if (students.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No students yet. Upload Excel file to add students.</p></div>';
                return;
            }
            
            container.innerHTML = students.map((student, index) => {
                const absences = student.attendance?.filter(a => !a.present).length || 0;
                const totalGrade = calculateTotalGrade(student.grades);
                return `
                    <div class="student-list-item">
                        <div>
                            <div class="student-name">${index + 1}. ${student.name}</div>
                            <div class="student-info">
                                Grade: ${totalGrade !== null ? `${totalGrade}/100` : 'Not graded'} | 
                                Absences: ${absences}
                            </div>
                        </div>
                        <button class="btn-small" onclick="viewStudentProfile('${className}', ${index})">View</button>
                    </div>
                `;
            }).join('');
        }
        
        // Calculate total grade
        function calculateTotalGrade(grades) {
            const g = grades;
            if (g.test1 === null || g.test2 === null || g.globalTest === null) return null;
            
            const tests = (g.test1 || 0) + (g.test2 || 0) + (g.globalTest || 0);
            const activities = (g.copyBook || 0) + (g.discipline || 0) + (g.oralTest || 0);
            return Math.round((tests + activities) * 10) / 10;
        }
        
        // View student profile
        function viewStudentProfile(className, studentIndex) {
            const students = getStudents(className);
            const student = students[studentIndex];
            
            document.getElementById('studentName').textContent = `${student.name} - ${className}`;
            
            const totalGrade = calculateTotalGrade(student.grades);
            const absences = student.attendance?.filter(a => !a.present).length || 0;
            const totalClasses = student.attendance?.length || 0;
            const attendanceRate = totalClasses > 0 ? Math.round((totalClasses - absences) / totalClasses * 100) : 100;
            
            // Get absence dates
            const absenceDates = student.attendance?.filter(a => !a.present).map(a => ({
                date: new Date(a.date).toLocaleDateString(),
                lesson: a.lesson
            })) || [];
            
            const profile = `
                <div class="card">
                    <h3>üìä Academic Performance</h3>
                    <div class="stat-grid">
                        <div class="stat-box">
                            <div class="stat-value">${totalGrade !== null ? totalGrade : '--'}</div>
                            <div class="stat-label">Final Grade /100</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value">${attendanceRate}%</div>
                            <div class="stat-label">Attendance Rate</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <p><strong>Tests (60%):</strong></p>
                        <p>‚Ä¢ Test 1: ${student.grades.test1 !== null ? `${student.grades.test1}/15` : 'Not graded'}</p>
                        <p>‚Ä¢ Test 2: ${student.grades.test2 !== null ? `${student.grades.test2}/15` : 'Not graded'}</p>
                        <p>‚Ä¢ Global Test: ${student.grades.globalTest !== null ? `${student.grades.globalTest}/30` : 'Not graded'}</p>
                        
                        <p style="margin-top: 15px;"><strong>Activities (40%):</strong></p>
                        <p>‚Ä¢ Copy Book: ${student.grades.copyBook !== null ? `${student.grades.copyBook}/24` : 'Not graded'} ${student.hasCopyBook ? '‚úì' : '‚úó'}</p>
                        <p>‚Ä¢ Discipline: ${student.grades.discipline !== null ? `${student.grades.discipline}/8` : 'Not graded'}</p>
                        <p>‚Ä¢ Oral Test: ${student.grades.oralTest !== null ? `${student.grades.oralTest}/8` : 'Not graded'}</p>
                    </div>
                </div>
                
                <div class="card">
                    <h3>‚úì Attendance Record</h3>
                    <p>Total Classes: ${totalClasses}</p>
                    <p>Present: ${totalClasses - absences} days</p>
                    <p>Absent: ${absences} days (${100 - attendanceRate}%)</p>
                    
                    ${absenceDates.length > 0 ? `
                        <div style="margin-top: 15px;">
                            <p><strong>Absence Dates:</strong></p>
                            ${absenceDates.map(a => `<p style="font-size: 13px; color: #666;">‚Ä¢ ${a.date} - ${a.lesson}</p>`).join('')}
                        </div>
                    ` : '<p style="margin-top: 10px; color: #28a745;">Perfect attendance! üéâ</p>'}
                </div>
                
                <div class="card">
                    <h3>üìì Copy Book Status</h3>
                    <p>Has Copy Book: ${student.hasCopyBook ? '‚úÖ Yes' : '‚ùå No'}</p>
                    ${student.hasCopyBook && student.grades.copyBook !== null ? 
                        `<p>Grade: ${student.grades.copyBook}/24 (${Math.round(student.grades.copyBook/24*100)}%)</p>` : 
                        ''}
                </div>
            `;
            
            document.getElementById('studentProfile').innerHTML = profile;
            document.getElementById('studentModal').classList.add('active');
        }
        
        // Grade entry
        function openGradeEntry() {
            const className = document.getElementById('studentClassFilter').value;
            const students = getStudents(className);
            
            if (students.length === 0) {
                alert('No students in this class. Please upload student list first.');
                return;
            }
            
            document.getElementById('gradeSubtitle').textContent = className;
            updateGradeForm();
            document.getElementById('gradeModal').classList.add('active');
        }
        
        function updateGradeForm() {
            const className = document.getElementById('studentClassFilter').value;
            const students = getStudents(className);
            const gradeType = document.getElementById('gradeType').value;
            
            const maxGrades = {
                test1: 15,
                test2: 15,
                globalTest: 30,
                copyBook: 24,
                discipline: 8,
                oralTest: 8
            };
            
            const container = document.getElementById('gradesList');
            container.innerHTML = students.map((student, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                    <span>${index + 1}. ${student.name}</span>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <input type="number" 
                               class="grade-input" 
                               id="grade-${index}"
                               min="0" 
                               max="${maxGrades[gradeType]}"
                               step="0.5"
                               value="${student.grades[gradeType] || ''}"
                               placeholder="--">
                        <span>/${maxGrades[gradeType]}</span>
                        ${gradeType === 'copyBook' ? `
                            <label style="margin-left: 10px; font-size: 12px;">
                                <input type="checkbox" 
                                       id="copybook-${index}"
                                       ${student.hasCopyBook ? 'checked' : ''}>
                                Has book
                            </label>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }
        
        function saveGrades() {
            const className = document.getElementById('studentClassFilter').value;
            const students = getStudents(className);
            const gradeType = document.getElementById('gradeType').value;
            
            students.forEach((student, index) => {
                const gradeInput = document.getElementById(`grade-${index}`);
                const value = gradeInput.value;
                student.grades[gradeType] = value !== '' ? parseFloat(value) : null;
                
                if (gradeType === 'copyBook') {
                    const copyBookCheck = document.getElementById(`copybook-${index}`);
                    student.hasCopyBook = copyBookCheck.checked;
                }
            });
            
            saveStudents(className, students);
            closeModal('gradeModal');
            alert('‚úì Grades saved!');
            displayStudentsList();
        }
        
        // Display holidays
        function displayHolidays() {
            const nationalContainer = document.getElementById('nationalHolidays');
            nationalContainer.innerHTML = moroccanHolidays.national.map(holiday => `
                <div class="holiday-item">
                    <div class="holiday-date">${new Date(holiday.date).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}</div>
                    <div class="holiday-name">${holiday.name}</div>
                    <span class="holiday-type fixed">‚úì Fixed</span>
                </div>
            `).join('');
            
            const religiousContainer = document.getElementById('religiousHolidays');
            religiousContainer.innerHTML = moroccanHolidays.religious.map(holiday => `
                <div class="holiday-item">
                    <div class="holiday-date">~${new Date(holiday.date).toLocaleDateString('en-US', {month: 'long', day: 'numeric', year: 'numeric'})}</div>
                    <div class="holiday-name">${holiday.name}</div>
                    <span class="holiday-type approximate">‚ö†Ô∏è Approximate</span>
                    <button class="btn-small" style="margin-top: 5px;" onclick="editHolidayDate('${holiday.date}')">‚úèÔ∏è Update</button>
                </div>
            `).join('');
        }
        
        // Display all records
        function displayAllRecords() {
            const lessons = getLessons();
            const filter = document.getElementById('classFilter').value;
            const container = document.getElementById('recordsList');
            
            let filtered = filter ? lessons.filter(l => l.class === filter) : lessons;
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No lessons recorded yet</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(lesson => `
                <div class="class-card" onclick='editLesson(${JSON.stringify(lesson).replace(/'/g, "&#39;")})'>
                    <div class="class-time">${new Date(lesson.date).toLocaleDateString()}</div>
                    <div class="class-name">${lesson.class} - ${lesson.title}</div>
                    <div style="font-size: 13px; color: #666; margin-top: 5px;">
                        ${lesson.type} ‚Ä¢ ${lesson.materials}
                    </div>
                </div>
            `).join('');
        }
        
        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.bottom-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.bottom-nav-item').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tab === 'today') {
                document.getElementById('todayTab').classList.add('active');
                displayTodayClasses();
            } else if (tab === 'records') {
                document.getElementById('recordsTab').classList.add('active');
                displayAllRecords();
            } else if (tab === 'students') {
                document.getElementById('studentsTab').classList.add('active');
                displayStudentsList();
            } else if (tab === 'holidays') {
                document.getElementById('holidaysTab').classList.add('active');
                displayHolidays();
            } else if (tab === 'export') {
                document.getElementById('exportTab').classList.add('active');
            }
        }
        
        // Export functions
        function exportFullRecord() {
            alert('üìÑ Generating complete record book with all students, grades, attendance, and lessons...\n\nThis feature will generate a comprehensive PDF report.');
        }
        
        function exportClassReport() {
            alert('üìä Generating class statistics report...');
        }
        
        function exportGradeSheet() {
            alert('üìà Generating grade sheet...');
        }
        
        // Event listeners
        document.getElementById('classFilter').addEventListener('change', displayAllRecords);
        document.getElementById('studentClassFilter').addEventListener('change', displayStudentsList);
        
        document.getElementById('lessonModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal('lessonModal');
        });
        
        document.getElementById('attendanceModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal('attendanceModal');
        });
        
        // Initialize
        displayCurrentDate();
        displayTodayClasses();
        displayAllRecords();
        displayStudentsList();
        displayHolidays();
    </script>
</body>
</html>
